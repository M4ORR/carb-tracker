<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>מעקב פחמימות - אפליקציה מלאה</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Rubik&display=swap');
  /* בסיס */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Rubik', sans-serif;
    background: #f0f4f8;
    color: #222;
    direction: rtl;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #007a7a;
    color: white;
    padding: 12px 24px;
    font-size: 1.8rem;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,122,122,0.4);
  }
  main {
    flex: 1;
    max-width: 1000px;
    margin: 20px auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: row;
    overflow: hidden;
  }
  nav#sidebar {
    width: 260px;
    background: #e1f0f0;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    border-right: 2px solid #007a7a;
  }
  nav#sidebar h2 {
    margin: 0 0 8px 0;
    color: #004d4d;
    font-size: 1.4rem;
  }
  nav#sidebar button {
    background: transparent;
    border: none;
    text-align: right;
    font-size: 1.1rem;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
    color: #007a7a;
    font-weight: 600;
  }
  nav#sidebar button.active,
  nav#sidebar button:hover {
    background: #007a7a;
    color: white;
  }
  section#content {
    flex: 1;
    padding: 24px 32px;
    overflow-y: auto;
  }
  h2.section-title {
    margin-top: 0;
    color: #007a7a;
    font-size: 1.8rem;
    border-bottom: 2px solid #007a7a;
    padding-bottom: 6px;
  }
  /* רשימת מאכלים וקטגוריות */
  #search-input {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 12px;
    border: 1.8px solid #ccc;
    margin-bottom: 16px;
    transition: border-color 0.3s;
  }
  #search-input:focus {
    outline: none;
    border-color: #007a7a;
    box-shadow: 0 0 8px #007a7a;
  }
  #food-list {
    max-height: 350px;
    overflow-y: auto;
    border: 1.5px solid #ccc;
    border-radius: 12px;
    padding: 8px;
    background: #fafafa;
  }
  .food-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
    align-items: center;
  }
  .food-item:last-child {
    border-bottom: none;
  }
  .food-name {
    font-weight: 600;
    flex: 1;
  }
  .food-carb {
    font-size: 14px;
    color: #555;
    margin-left: 12px;
    white-space: nowrap;
  }
  .food-qty input {
    width: 70px;
    font-size: 14px;
    padding: 6px 8px;
    border-radius: 10px;
    border: 1.5px solid #ccc;
    text-align: center;
    transition: border-color 0.3s;
  }
  .food-qty input:focus {
    border-color: #007a7a;
    outline: none;
    box-shadow: 0 0 6px #007a7a;
  }

  /* תצרוכת נוכחית */
  #tracker-container {
    margin-top: 24px;
  }
  #selected-foods {
    max-height: 220px;
    overflow-y: auto;
    border: 1.5px solid #ccc;
    border-radius: 12px;
    padding: 10px;
    background: #fafafa;
    margin-bottom: 16px;
  }
  .selected-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 12px;
    border-bottom: 1px solid #ddd;
    align-items: center;
  }
  .selected-item:last-child {
    border-bottom: none;
  }
  .selected-name {
    font-weight: 700;
  }
  .selected-carb {
    color: #005050;
  }
  #total-carb {
    font-size: 1.5rem;
    font-weight: 700;
    color: #004040;
    text-align: center;
  }
  #reset-button {
    margin-top: 12px;
    width: 100%;
    padding: 12px 0;
    background: #007a7a;
    border: none;
    border-radius: 16px;
    font-size: 1.2rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,122,122,0.4);
    transition: background-color 0.3s;
  }
  #reset-button:hover {
    background: #005050;
  }
  /* הוספת מאכל */
  #add-food-form {
    margin-top: 32px;
    border-top: 2px solid #007a7a;
    padding-top: 16px;
  }
  #add-food-form label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #007a7a;
  }
  #add-food-form input {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1.8px solid #ccc;
    transition: border-color 0.3s;
  }
  #add-food-form input:focus {
    border-color: #007a7a;
    outline: none;
    box-shadow: 0 0 6px #007a7a;
  }
  #add-food-form button {
    width: 100%;
    padding: 12px 0;
    background: #009999;
    border: none;
    border-radius: 16px;
    color: white;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #add-food-form button:hover {
    background: #006666;
  }

  /* גרפים */
  #chart-container {
    margin-top: 40px;
  }
  canvas#carbChart {
    max-width: 100%;
    border-radius: 12px;
    background: #f7fafc;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  }

  /* נגישות */
  button:focus, input:focus {
    outline-offset: 3px;
  }

  /* רספונסיביות */
  @media (max-width: 900px) {
    main {
      flex-direction: column;
    }
    nav#sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 2px solid #007a7a;
      flex-direction: row;
      overflow-x: auto;
      padding: 12px;
      gap: 8px;
    }
    nav#sidebar button {
      flex: 1 0 auto;
      font-size: 1rem;
      padding: 10px 8px;
    }
    section#content {
      padding: 16px 20px;
    }
  }
</style>
</head>
<body>
<header>מעקב פחמימות - אפליקציה מלאה</header>
<main>
  <nav id="sidebar" role="navigation" aria-label="תפריט ניווט">
    <button class="active" data-section="tracker" aria-current="page">מעקב</button>
    <button data-section="addFood">הוספת מאכל</button>
    <button data-section="stats">סטטיסטיקות</button>
  </nav>
  <section id="content" tabindex="0">
    <!-- תוכן דינמי -->
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // נתוני מאכלים התחלתיים עם קטגוריות
  const foods = [
    { name: "לחם לבן", carbsPer100g: 49, category: "דגנים" },
    { name: "אורז מבושל", carbsPer100g: 28, category: "דגנים" },
    { name: "תפוח", carbsPer100g: 14, category: "פירות" },
    { name: "בננה", carbsPer100g: 23, category: "פירות" },
    { name: "חומוס מבושל", carbsPer100g: 27, category: "קטניות" },
    { name: "חלב", carbsPer100g: 5, category: "מוצרי חלב" },
    { name: "עגבנייה", carbsPer100g: 4, category: "ירקות" },
    { name: "מלפפון", carbsPer100g: 3.6, category: "ירקות" },
    { name: "סוכר", carbsPer100g: 100, category: "מתוקים" },
    { name: "עוגה שוקולד", carbsPer100g: 50, category: "מתוקים" }
  ];

  // שמירת המצב: מאכלים שהמשתמש הוסיף, תצרוכת יומית, משתמש
  let customFoods = [];
  let selectedFoods = {}; // { "לחם לבן": { qty, carbs, category } }
  let currentSection = 'tracker';

  // HTML templates
  function trackerTemplate() {
    return `
      <h2 class="section-title">מעקב תצרוכת פחמימות</h2>
      <input id="search-input" type="search" placeholder="חפש מאכל..." aria-label="חיפוש מאכלים" autocomplete="off" />
      <div id="food-list" role="list" tabindex="0" aria-label="רשימת מאכלים"></div>
      <div id="tracker-container" aria-live="polite" aria-atomic="true">
        <h3>תצרוכת נוכחית</h3>
        <div id="selected-foods" role="list" tabindex="0" aria-label="מאכלים שנבחרו"></div>
        <div id="total-carb">סה"כ פחמימות: 0 גרם</div>
        <button id="reset-button" aria-label="איפוס כל הבחירות">אפס הכל</button>
      </div>
    `;
  }
  function addFoodTemplate() {
    return `
      <h2 class="section-title">הוסף מאכל מותאם אישית</h2>
      <form id="add-food-form" aria-label="טופס הוספת מאכל">
        <label for="food-name">שם המאכל:</label>
        <input id="food-name" type="text" required placeholder="לדוגמה: קינואה" />
        <label for="food-carbs">פחמימות ל-100 גרם:</label>
        <input id="food-carbs" type="number" min="0" step="0.1" required placeholder="לדוגמה: 21" />
        <label for="food-category">קטגוריה:</label>
        <select id="food-category" required>
          <option value="" disabled selected>בחר קטגוריה</option>
          <option value="דגנים">דגנים</option>
          <option value="פירות">פירות</option>
          <option value="ירקות">ירקות</option>
          <option value="קטניות">קטניות</option>
          <option value="מוצרי חלב">מוצרי חלב</option>
          <option value="מתוקים">מתוקים</option>
          <option value="אחר">אחר</option>
        </select>
        <button type="submit">הוסף מאכל</button>
      </form>
    `;
  }
  function statsTemplate() {
    return `
      <h2 class="section-title">סטטיסטיקות יומיות</h2>
      <canvas id="carbChart" aria-label="גרף צריכת פחמימות יומית" role="img"></canvas>
      <p style="margin-top: 12px; color: #555;">הגרף מציג את סך הפחמימות שנצרכו בכל יום ב-7 הימים האחרונים.</p>
    `;
  }

  // DOM references
  const content = document.getElementById('content');
  const sidebarButtons = document.querySelectorAll('#sidebar button');

  // מצבי אחסון ב־LocalStorage
  function loadState() {
    const sel = localStorage.getItem('carbTrackerSelectedFoods');
    selectedFoods = sel ? JSON.parse(sel) : {};
    const custom = localStorage.getItem('carbTrackerCustomFoods');
    customFoods = custom ? JSON.parse(custom) : [];
  }
  function saveState() {
    localStorage.setItem('carbTrackerSelectedFoods', JSON.stringify(selectedFoods));
    localStorage.setItem('carbTrackerCustomFoods', JSON.stringify(customFoods));
  }

  // איחוד מאכלים - תחילת מאכלים + מותאמים אישית
  function getAllFoods() {
    return [...foods, ...customFoods];
  }

  // ניווט בין חלקים
  function setSection(section) {
    currentSection = section;
    sidebarButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.section === section);
      if (btn.dataset.section === section) {
        btn.setAttribute('aria-current', 'page');
      } else {
        btn.removeAttribute('aria-current');
      }
    });
    if(section === 'tracker') {
      content.innerHTML = trackerTemplate();
      initTracker();
    } else if(section === 'addFood') {
      content.innerHTML = addFoodTemplate();
      initAddFood();
    } else if(section === 'stats') {
      content.innerHTML = statsTemplate();
      initStats();
    }
  }

  // --- מעקב תצרוכת ---

  function initTracker() {
    const foodListEl = document.getElementById('food-list');
    const searchInput = document.getElementById('search-input');
    const selectedFoodsEl = document.getElementById('selected-foods');
    const totalCarbEl = document.getElementById('total-carb');
    const resetButton = document.getElementById('reset-button');

    function createFoodItem(food) {
      const div = document.createElement('div');
      div.className = 'food-item';
      div.setAttribute('role', 'listitem');

      const nameSpan = document.createElement('span');
      nameSpan.className = 'food-name';
      nameSpan.textContent = food.name;

      const carbSpan = document.createElement('span');
      carbSpan.className = 'food-carb';
      carbSpan.textContent = `${food.carbsPer100g} גרם פחמימות ל-100 גרם`;

      const qtyDiv = document.createElement('div');
      qtyDiv.className = 'food-qty';

      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = 'any';
      input.placeholder = 'גרם';
      input.value = selectedFoods[food.name]?.qty || '';

      input.addEventListener('input', () => {
        let val = parseFloat(input.value);
        if (isNaN(val) || val < 0) {
          val = 0;
        }
        if (val === 0) {
          delete selectedFoods[food.name];
        } else {
          selectedFoods[food.name] = {
            qty: val,
            carbs: (food.carbsPer100g * val) / 100,
            category: food.category
          };
        }
        saveState();
        renderSelectedFoods();
      });

      qtyDiv.appendChild(input);

      div.appendChild(nameSpan);
      div.appendChild(carbSpan);
      div.appendChild(qtyDiv);

      return div;
    }

    function renderFoodList(filter = '') {
      foodListEl.innerHTML = '';
      const lowerFilter = filter.trim().toLowerCase();
      getAllFoods()
        .filter(f => f.name.toLowerCase().includes(lowerFilter))
        .forEach(food => {
          foodListEl.appendChild(createFoodItem(food));
        });
    }

    function renderSelectedFoods() {
      selectedFoodsEl.innerHTML = '';
      const entries = Object.entries(selectedFoods);
      if(entries.length === 0) {
        selectedFoodsEl.textContent = 'לא נבחרו מאכלים';
        totalCarbEl.textContent = 'סה"כ פחמימות: 0 גרם';
        return;
      }
      let total = 0;
      entries.forEach(([name, data]) => {
        total += data.carbs;
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.setAttribute('role', 'listitem');

        const nameSpan = document.createElement('span');
        nameSpan.className = 'selected-name';
        nameSpan.textContent = name;

        const carbSpan = document.createElement('span');
        carbSpan.className = 'selected-carb';
        carbSpan.textContent = `${data.carbs.toFixed(1)} גרם`;

        div.appendChild(nameSpan);
        div.appendChild(carbSpan);
        selectedFoodsEl.appendChild(div);
      });
      totalCarbEl.textContent = `סה"כ פחמימות: ${total.toFixed(1)} גרם`;
    }

    resetButton.addEventListener('click', () => {
      selectedFoods = {};
      saveState();
      renderFoodList(searchInput.value);
      renderSelectedFoods();
    });

    searchInput.addEventListener('input', () => {
      renderFoodList(searchInput.value);
    });

    // אתחול
    renderFoodList();
    renderSelectedFoods();
  }

  // --- הוספת מאכל מותאם אישית ---
  function initAddFood() {
    const form = document.getElementById('add-food-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const nameInput = form.querySelector('#food-name');
      const carbsInput = form.querySelector('#food-carbs');
      const categorySelect = form.querySelector('#food-category');
      const name = nameInput.value.trim();
      const carbs = parseFloat(carbsInput.value);
      const category = categorySelect.value;

      if (!name || isNaN(carbs) || carbs < 0 || !category) {
        alert('אנא מלא את כל השדות כראוי.');
        return;
      }

      // בדיקה אם המאכל כבר קיים (במקור או מותאם אישית)
      const allFoods = getAllFoods();
      const exists = allFoods.some(f => f.name.toLowerCase() === name.toLowerCase());
      if (exists) {
        alert('המאכל כבר קיים ברשימה.');
        return;
      }

      customFoods.push({ name, carbsPer100g: carbs, category });
      saveState();
      alert(`המאכל "${name}" נוסף בהצלחה!`);

      // נקה טופס
      form.reset();
    });
  }

  // --- סטטיסטיקות וגרפים ---
  let chartInstance = null;
  function initStats() {
    const ctx = document.getElementById('carbChart').getContext('2d');
    if(chartInstance) {
      chartInstance.destroy();
    }

    // נקבל נתונים אחרונים 7 ימים
    // לצורך דוגמה, נשתמש באחסון זמני ב-LocalStorage
    // מבנה: {'carbTrackerHistory': JSON.stringify({ '2025-08-01': 45, ... })}
    const historyRaw = localStorage.getItem('carbTrackerHistory');
    const history = historyRaw ? JSON.parse(historyRaw) : {};

    // בנה מערך של 7 ימים אחרונים בתאריכים בפורמט YYYY-MM-DD
    const dates = [];
    for(let i=6; i>=0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      dates.push(d.toISOString().slice(0,10));
    }
    // אסוף ערכי פחמימות לפי תאריך
    const data = dates.map(date => history[date] || 0);

    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'פחמימות ליום (גרם)',
          data,
          borderColor: '#007a7a',
          backgroundColor: 'rgba(0, 122, 122, 0.3)',
          fill: true,
          tension: 0.3,
          pointRadius: 5,
          pointHoverRadius: 7,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              font: {
                size: 16,
                family: 'Rubik'
              }
            }
          }
        }
      }
    });
  }

  // --- שמירת היסטוריית צריכה יומית (פיצ׳ר מתקדם) ---
  // בזמן טעינת tracker, ניתן להוסיף כפתור 'שמור היום' כדי להוסיף את סך הפחמימות להיסטוריה
  // להלן פונקציה שניתן להוסיף למעקב:

  function saveTodayToHistory() {
    const totalCarbs = Object.values(selectedFoods).reduce((acc, f) => acc + f.carbs, 0);
    if(totalCarbs === 0) return;

    const today = new Date().toISOString().slice(0,10);
    const historyRaw = localStorage.getItem('carbTrackerHistory');
    const history = historyRaw ? JSON.parse(historyRaw) : {};

    history[today] = totalCarbs;
    localStorage.setItem('carbTrackerHistory', JSON.stringify(history));
  }

  // נוכל להוסיף כפתור למעקב לשמירת היום:
  // אחרי renderSelectedFoods() ב-initTracker(), נוסיף את הכפתור ונחבר אותו:

  function addSaveTodayButton() {
    const trackerContainer = document.getElementById('tracker-container');
    if(document.getElementById('save-today-btn')) return;
    const btn = document.createElement('button');
    btn.id = 'save-today-btn';
    btn.textContent = 'שמור את צריכת היום';
    btn.style.marginTop = '12px';
    btn.style.width = '100%';
    btn.style.padding = '12px 0';
    btn.style.background = '#005050';
    btn.style.color = 'white';
    btn.style.border = 'none';
    btn.style.borderRadius = '16px';
    btn.style.fontSize = '1.2rem';
    btn.style.cursor = 'pointer';
    btn.addEventListener('click', () => {
      saveTodayToHistory();
      alert('צריכת היום נשמרה בהצלחה!');
    });
    trackerContainer.appendChild(btn);
  }

  // --- התחלת המערכת ---
  // התנהגות כפתורי הניווט
  sidebarButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      setSection(btn.dataset.section);
    });
  });

  // טעינת מצב ושלב ראשוני
  function init() {
    loadState();
    setSection('tracker');
  }

  // הרחבת initTracker להוספת כפתור שמירה
  const originalInitTracker = initTracker;
  initTracker = function() {
    originalInitTracker();
    addSaveTodayButton();
  }

  init();
</script>
</body>
</html>
