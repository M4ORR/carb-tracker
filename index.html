<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>מעקב פחמימות - אפליקציה משודרגת</title>
<style>
  /* ... כל הסגנונות כפי ששלחתי קודם ... */
  @import url('https://fonts.googleapis.com/css2?family=Rubik&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    font-family: 'Rubik', sans-serif;
    background: #f0f4f8;
    color: #222;
    direction: rtl;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #007a7a;
    color: white;
    padding: 12px 24px;
    font-size: 1.8rem;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0,122,122,0.4);
  }
  main {
    flex: 1;
    max-width: 1000px;
    margin: 20px auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: row;
    overflow: hidden;
    flex-wrap: wrap;
  }
  nav#sidebar {
    width: 260px;
    max-width: 100%;
    background: #e1f0f0;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    border-right: 2px solid #007a7a;
    flex-shrink: 0;
  }
  nav#sidebar h2 {
    margin: 0 0 8px 0;
    color: #004d4d;
    font-size: 1.4rem;
  }
  nav#sidebar button {
    background: transparent;
    border: none;
    text-align: right;
    font-size: 1.1rem;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
    color: #007a7a;
    font-weight: 600;
  }
  nav#sidebar button.active,
  nav#sidebar button:hover {
    background: #007a7a;
    color: white;
  }
  section#content {
    flex: 1 1 0;
    padding: 24px 32px;
    overflow-y: auto;
    min-width: 0;
  }
  h2.section-title {
    margin-top: 0;
    color: #007a7a;
    font-size: 1.8rem;
    border-bottom: 2px solid #007a7a;
    padding-bottom: 6px;
  }
  #search-input {
    width: 100%;
    padding: 10px 12px;
    font-size: 16px;
    border-radius: 12px;
    border: 1.8px solid #ccc;
    margin-bottom: 16px;
    transition: border-color 0.3s;
  }
  #search-input:focus {
    outline: none;
    border-color: #007a7a;
    box-shadow: 0 0 8px #007a7a;
  }
  #food-list {
    max-height: 350px;
    overflow-y: auto;
    border: 1.5px solid #ccc;
    border-radius: 12px;
    padding: 8px;
    background: #fafafa;
  }
  .food-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #ddd;
    align-items: center;
  }
  .food-item:last-child {
    border-bottom: none;
  }
  .food-name {
    font-weight: 600;
    flex: 1;
  }
  .food-carb {
    font-size: 14px;
    color: #555;
    margin-left: 12px;
    white-space: nowrap;
  }
  .food-qty input {
    width: 70px;
    font-size: 14px;
    padding: 6px 8px;
    border-radius: 10px;
    border: 1.5px solid #ccc;
    text-align: center;
    transition: border-color 0.3s;
  }
  .food-qty input:focus {
    border-color: #007a7a;
    outline: none;
    box-shadow: 0 0 6px #007a7a;
  }

  #tracker-container {
    margin-top: 24px;
  }
  #selected-foods {
    max-height: 220px;
    overflow-y: auto;
    border: 1.5px solid #ccc;
    border-radius: 12px;
    padding: 10px;
    background: #fafafa;
    margin-bottom: 16px;
  }
  .selected-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 12px;
    border-bottom: 1px solid #ddd;
    align-items: center;
  }
  .selected-item:last-child {
    border-bottom: none;
  }
  .selected-name {
    font-weight: 700;
  }
  .selected-carb {
    color: #005050;
  }
  #total-carb {
    font-size: 1.5rem;
    font-weight: 700;
    color: #004040;
    text-align: center;
  }
  #save-day-button, #reset-button {
    margin-top: 12px;
    width: 48%;
    padding: 12px 0;
    background: #007a7a;
    border: none;
    border-radius: 16px;
    font-size: 1.2rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,122,122,0.4);
    transition: background-color 0.3s;
  }
  #save-day-button:hover, #reset-button:hover {
    background: #005050;
  }
  #buttons-row {
    display: flex;
    justify-content: space-between;
  }

  #add-food-form {
    margin-top: 32px;
    border-top: 2px solid #007a7a;
    padding-top: 16px;
  }
  #add-food-form label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #007a7a;
  }
  #add-food-form input,
  #add-food-form select {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    margin-bottom: 12px;
    border-radius: 10px;
    border: 1.8px solid #ccc;
    transition: border-color 0.3s;
  }
  #add-food-form input:focus,
  #add-food-form select:focus {
    border-color: #007a7a;
    outline: none;
    box-shadow: 0 0 6px #007a7a;
  }
  #add-food-form button {
    width: 100%;
    padding: 12px 0;
    background: #009999;
    border: none;
    border-radius: 16px;
    color: white;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  #add-food-form button:hover {
    background: #006666;
  }

  #chart-container {
    margin-top: 40px;
  }
  canvas#carbChart {
    max-width: 100%;
    border-radius: 12px;
    background: #f7fafc;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
  }

  /* יצוא וייבוא */
  #export-import-container {
    margin-top: 30px;
    border: 2px solid #007a7a;
    border-radius: 16px;
    padding: 16px;
    background: #e9f7f7;
  }
  #export-import-container textarea {
    width: 100%;
    height: 120px;
    font-family: monospace;
    font-size: 0.9rem;
    border-radius: 10px;
    border: 1.5px solid #007a7a;
    padding: 8px;
    resize: vertical;
  }
  #export-import-container button {
    margin-top: 8px;
    width: 48%;
    padding: 12px 0;
    background: #007a7a;
    border: none;
    border-radius: 16px;
    font-size: 1.1rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,122,122,0.5);
    transition: background-color 0.3s;
  }
  #export-import-container button:hover {
    background: #005050;
  }
  #export-import-container .buttons-row {
    display: flex;
    justify-content: space-between;
  }

  button:focus, input:focus, select:focus, textarea:focus {
    outline-offset: 3px;
  }

  @media (max-width: 900px) {
    main {
      flex-direction: column;
      margin: 10px;
      border-radius: 12px;
    }
    nav#sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 2px solid #007a7a;
      flex-direction: row;
      overflow-x: auto;
      padding: 12px;
      gap: 8px;
    }
    nav#sidebar button {
      flex: 1 0 auto;
      font-size: 1rem;
      padding: 10px 8px;
    }
    section#content {
      padding: 16px 20px;
      min-height: 300px;
    }
    #save-day-button, #reset-button {
      width: 100%;
      margin-top: 8px;
    }
    #buttons-row {
      flex-direction: column;
    }
    #export-import-container .buttons-row {
      flex-direction: column;
      gap: 8px;
    }
    #export-import-container button {
      width: 100%;
    }
  }
</style>
</head>
<body>
<header>מעקב פחמימות - אפליקציה משודרגת</header>
<main>
  <nav id="sidebar" role="navigation" aria-label="תפריט ניווט">
    <button class="active" data-section="tracker" aria-current="page">מעקב</button>
    <button data-section="addFood">הוספת מאכל</button>
    <button data-section="stats">סטטיסטיקות</button>
  </nav>
  <section id="content" tabindex="0">
    <!-- תוכן דינמי -->
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // מאכלים התחלתיים
  const foods = [
    { name: "לחם לבן", carbsPer100g: 49, category: "דגנים" },
    { name: "אורז מבושל", carbsPer100g: 28, category: "דגנים" },
    { name: "תפוח", carbsPer100g: 14, category: "פירות" },
    { name: "בננה", carbsPer100g: 23, category: "פירות" },
    { name: "חומוס מבושל", carbsPer100g: 27, category: "קטניות" },
    { name: "חלב", carbsPer100g: 5, category: "מוצרי חלב" },
    { name: "עגבנייה", carbsPer100g: 4, category: "ירקות" },
    { name: "מלפפון", carbsPer100g: 3.6, category: "ירקות" },
    { name: "סוכר", carbsPer100g: 100, category: "מתוקים" },
    { name: "עוגה שוקולד", carbsPer100g: 50, category: "מתוקים" }
  ];

  let customFoods = [];
  // צריכה יומית לפי תאריך במבנה: { 'YYYY-MM-DD': { 'לחם לבן': {qty, carbs, category}, ... }, ... }
  let dailyConsumption = {};
  let currentSection = 'tracker';

  // עזרות תאריך
  function formatDate(date = new Date()) {
    return date.toISOString().slice(0,10);
  }
  function parseDate(str) {
    return new Date(str);
  }
  function getLastNDates(n) {
    const dates = [];
    for(let i = n-1; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      dates.push(formatDate(d));
    }
    return dates;
  }

  // טעינה ושמירה מ־localStorage
  function loadState() {
    const custom = localStorage.getItem('carbTrackerCustomFoods');
    customFoods = custom ? JSON.parse(custom) : [];
    const daily = localStorage.getItem('carbTrackerDailyConsumption');
    dailyConsumption = daily ? JSON.parse(daily) : {};
  }
  function saveState() {
    localStorage.setItem('carbTrackerCustomFoods', JSON.stringify(customFoods));
    localStorage.setItem('carbTrackerDailyConsumption', JSON.stringify(dailyConsumption));
  }

  function getAllFoods() {
    return [...foods, ...customFoods];
  }

  // --- ניווט ---

  const content = document.getElementById('content');
  const sidebarButtons = document.querySelectorAll('#sidebar button');

  function setSection(section) {
    currentSection = section;
    sidebarButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.section === section);
      if (btn.dataset.section === section) {
        btn.setAttribute('aria-current', 'page');
      } else {
        btn.removeAttribute('aria-current');
      }
    });
    if(section === 'tracker') {
      content.innerHTML = trackerTemplate();
      initTracker();
    } else if(section === 'addFood') {
      content.innerHTML = addFoodTemplate();
      initAddFood();
    } else if(section === 'stats') {
      content.innerHTML = statsTemplate();
      initStats();
    }
  }
  sidebarButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if(btn.dataset.section !== currentSection) {
        setSection(btn.dataset.section);
      }
    });
  });

  // --- תבניות HTML ---

  function trackerTemplate() {
    const today = formatDate();
    return `
      <h2 class="section-title">מעקב תצרוכת פחמימות</h2>
      <p>תאריך: <input type="date" id="date-picker" value="${today}" max="${today}" aria-label="בחירת תאריך לצפייה ועריכה"></p>
      <input id="search-input" type="search" placeholder="חפש מאכל..." aria-label="חיפוש מאכלים" autocomplete="off" />
      <div id="food-list" role="list" tabindex="0" aria-label="רשימת מאכלים"></div>
      <div id="tracker-container" aria-live="polite" aria-atomic="true">
        <h3>תצרוכת נוכחית</h3>
        <div id="selected-foods" role="list" tabindex="0" aria-label="מאכלים שנבחרו"></div>
        <div id="total-carb">סה"כ פחמימות: 0 גרם</div>
        <div id="buttons-row">
          <button id="save-day-button" aria-label="שמור תצרוכת יומית">שמור יום</button>
          <button id="reset-button" aria-label="איפוס התצרוכת ליום זה">אפס יום</button>
        </div>
      </div>
    `;
  }

  function addFoodTemplate() {
    return `
      <h2 class="section-title">הוסף מאכל מותאם אישית</h2>
      <form id="add-food-form" aria-label="טופס הוספת מאכל">
        <label for="food-name">שם המאכל:</label>
        <input id="food-name" type="text" required placeholder="לדוגמה: קינואה" />
        <label for="food-carbs">פחמימות ל-100 גרם:</label>
        <input id="food-carbs" type="number" min="0" step="0.1" required placeholder="לדוגמה: 21" />
        <label for="food-category">קטגוריה:</label>
        <select id="food-category" required>
          <option value="" disabled selected>בחר קטגוריה</option>
          <option value="דגנים">דגנים</option>
          <option value="פירות">פירות</option>
          <option value="ירקות">ירקות</option>
          <option value="קטניות">קטניות</option>
          <option value="מוצרי חלב">מוצרי חלב</option>
          <option value="מתוקים">מתוקים</option>
          <option value="אחר">אחר</option>
        </select>
        <button type="submit">הוסף מאכל</button>
      </form>
    `;
  }

  function statsTemplate() {
    return `
      <h2 class="section-title">סטטיסטיקות גרף פחמימות אחרונות</h2>
      <div id="chart-container">
        <canvas id="carbChart" aria-label="גרף צריכת פחמימות יומית" role="img"></canvas>
      </div>
      <div id="export-import-container" aria-label="יצוא וייבוא נתוני האפליקציה">
        <h3>יצוא וייבוא נתונים</h3>
        <textarea id="export-import-textarea" aria-label="אזור טקסט ליצוא וייבוא נתונים" placeholder="כאן יוצג/יוכנס הנתונים..."></textarea>
        <div class="buttons-row">
          <button id="export-data-btn" aria-label="ייצוא הנתונים">ייצוא נתונים</button>
          <button id="import-data-btn" aria-label="ייבוא הנתונים">ייבוא נתונים</button>
        </div>
      </div>
    `;
  }

  // --- מעקב ---

  function initTracker() {
    const datePicker = document.getElementById('date-picker');
    const searchInput = document.getElementById('search-input');
    const foodListEl = document.getElementById('food-list');
    const selectedFoodsEl = document.getElementById('selected-foods');
    const totalCarbEl = document.getElementById('total-carb');
    const saveDayButton = document.getElementById('save-day-button');
    const resetButton = document.getElementById('reset-button');

    let selectedFoods = {};

    function loadDayData(date) {
      selectedFoods = dailyConsumption[date] ? {...dailyConsumption[date]} : {};
    }
    function saveDayData(date) {
      if(Object.keys(selectedFoods).length === 0) {
        delete dailyConsumption[date];
      } else {
        dailyConsumption[date] = {...selectedFoods};
      }
      saveState();
    }

    function createFoodItem(food) {
      const div = document.createElement('div');
      div.className = 'food-item';
      div.setAttribute('role', 'listitem');

      const nameSpan = document.createElement('span');
      nameSpan.className = 'food-name';
      nameSpan.textContent = food.name;

      const carbSpan = document.createElement('span');
      carbSpan.className = 'food-carb';
      carbSpan.textContent = `${food.carbsPer100g.toFixed(1)} גרם ל-100 גרם`;

      const qtyDiv = document.createElement('div');
      qtyDiv.className = 'food-qty';

      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = 0;
      qtyInput.step = 1;
      qtyInput.value = selectedFoods[food.name]?.qty ?? 0;
      qtyInput.setAttribute('aria-label', `הזן גרמים של ${food.name}`);

      qtyInput.addEventListener('input', () => {
        const val = parseInt(qtyInput.value);
        if (isNaN(val) || val < 0) {
          qtyInput.value = 0;
          delete selectedFoods[food.name];
        } else if (val === 0) {
          delete selectedFoods[food.name];
        } else {
          selectedFoods[food.name] = {
            qty: val,
            carbs: (val * food.carbsPer100g / 100),
            category: food.category
          };
        }
        renderSelectedFoods();
      });

      qtyDiv.appendChild(qtyInput);

      div.appendChild(nameSpan);
      div.appendChild(carbSpan);
      div.appendChild(qtyDiv);

      return div;
    }

    function renderFoodList(filter = '') {
      foodListEl.innerHTML = '';
      const allFoods = getAllFoods();
      const filtered = allFoods.filter(f => f.name.includes(filter) || f.category.includes(filter));
      if(filtered.length === 0) {
        const noRes = document.createElement('p');
        noRes.textContent = 'לא נמצאו מאכלים';
        noRes.style.color = '#777';
        foodListEl.appendChild(noRes);
        return;
      }
      filtered.forEach(food => {
        foodListEl.appendChild(createFoodItem(food));
      });
    }

    function renderSelectedFoods() {
      selectedFoodsEl.innerHTML = '';
      const entries = Object.entries(selectedFoods);
      if(entries.length === 0) {
        selectedFoodsEl.textContent = 'לא נבחרו מאכלים';
        totalCarbEl.textContent = 'סה"כ פחמימות: 0 גרם';
        return;
      }
      let total = 0;
      entries.forEach(([name, data]) => {
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.setAttribute('role', 'listitem');

        const nameSpan = document.createElement('span');
        nameSpan.className = 'selected-name';
        nameSpan.textContent = name;

        const qtySpan = document.createElement('span');
        qtySpan.className = 'selected-qty';
        qtySpan.textContent = `${data.qty} גרם`;

        const carbSpan = document.createElement('span');
        carbSpan.className = 'selected-carb';
        carbSpan.textContent = `${data.carbs.toFixed(1)} גרם פחמימות`;

        div.appendChild(nameSpan);
        div.appendChild(qtySpan);
        div.appendChild(carbSpan);
        selectedFoodsEl.appendChild(div);

        total += data.carbs;
      });
      totalCarbEl.textContent = `סה"כ פחמימות: ${total.toFixed(1)} גרם`;
    }

    resetButton.addEventListener('click', () => {
      if(confirm('האם למחוק את כל הבחירות ליום זה?')) {
        selectedFoods = {};
        renderSelectedFoods();
        renderFoodList(searchInput.value);
        saveDayData(datePicker.value);
      }
    });

    saveDayButton.addEventListener('click', () => {
      saveDayData(datePicker.value);
      alert('תצרוכת היום נשמרה בהצלחה!');
      renderStatsChart();
    });

    searchInput.addEventListener('input', () => {
      renderFoodList(searchInput.value);
    });

    datePicker.addEventListener('change', () => {
      loadDayData(datePicker.value);
      renderSelectedFoods();
      renderFoodList(searchInput.value);
    });

    // אתחול התחלי
    loadDayData(datePicker.value);
    renderSelectedFoods();
    renderFoodList();
  }

  // --- הוספת מאכל ---

  function initAddFood() {
    const form = document.getElementById('add-food-form');
    form.addEventListener('submit', e => {
      e.preventDefault();
      const nameInput = form.querySelector('#food-name');
      const carbsInput = form.querySelector('#food-carbs');
      const categorySelect = form.querySelector('#food-category');

      const name = nameInput.value.trim();
      const carbs = parseFloat(carbsInput.value);
      const category = categorySelect.value;

      if (!name || isNaN(carbs) || carbs < 0 || !category) {
        alert('אנא מלא את כל השדות נכון.');
        return;
      }
      // בודק אם המאכל כבר קיים (בלי תלות באותיות)
      const exists = getAllFoods().some(f => f.name.toLowerCase() === name.toLowerCase());
      if(exists) {
        alert('מאכל עם שם זה כבר קיים.');
        return;
      }

      const newFood = { name, carbsPer100g: carbs, category };
      customFoods.push(newFood);
      saveState();

      alert('המאכל נוסף בהצלחה!');

      nameInput.value = '';
      carbsInput.value = '';
      categorySelect.value = '';

      setSection('tracker');
    });
  }

  // --- סטטיסטיקות וגרפים ---

  let chartInstance = null;

  function renderStatsChart() {
    const ctx = document.getElementById('carbChart').getContext('2d');
    const dates = getLastNDates(7);
    const carbsPerDay = dates.map(date => {
      if(!dailyConsumption[date]) return 0;
      return Object.values(dailyConsumption[date])
        .reduce((acc, item) => acc + item.carbs, 0);
    });

    if(chartInstance) {
      chartInstance.data.labels = dates.map(d => {
        const dt = new Date(d);
        return dt.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' });
      });
      chartInstance.data.datasets[0].data = carbsPerDay;
      chartInstance.update();
      return;
    }

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dates.map(d => {
          const dt = new Date(d);
          return dt.toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' });
        }),
        datasets: [{
          label: 'גרם פחמימות ביום',
          data: carbsPerDay,
          backgroundColor: '#007a7a',
          borderRadius: 6,
          barPercentage: 0.6,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        scales: {
          x: {
            ticks: { color: '#004040', font: { size: 14 } },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#004040', font: { size: 14 } },
            grid: { color: '#e0e0e0' }
          }
        }
      }
    });
  }

  function initStats() {
    renderStatsChart();
    initExportImport();
  }

  // --- יצוא וייבוא נתונים ---

  function initExportImport() {
    const exportBtn = document.getElementById('export-data-btn');
    const importBtn = document.getElementById('import-data-btn');
    const textarea = document.getElementById('export-import-textarea');

    exportBtn.addEventListener('click', () => {
      const dataToExport = {
        customFoods,
        dailyConsumption,
      };
      textarea.value = JSON.stringify(dataToExport, null, 2);
      textarea.focus();
      textarea.select();
      alert('נתוני האפליקציה יופיעו בתיבה למעלה. ניתן להעתיק ולשמור אותם.');
    });

    importBtn.addEventListener('click', () => {
      const text = textarea.value.trim();
      if(!text) {
        alert('אנא הדבק כאן נתוני JSON חוקיים לייבוא.');
        return;
      }
      try {
        const imported = JSON.parse(text);
        if(typeof imported !== 'object' || !imported.customFoods || !imported.dailyConsumption) {
          alert('קובץ ה-JSON אינו מתאים לפורמט הנדרש.');
          return;
        }
        // שומר את הנתונים ומעדכן המצב
        customFoods = imported.customFoods;
        dailyConsumption = imported.dailyConsumption;
        saveState();
        alert('הנתונים יובאו בהצלחה!');
        // במידה ואנחנו בטרקר - רענון התצוגה לפי תאריך נוכחי
        if(currentSection === 'tracker') {
          setSection('tracker');
        } else if(currentSection === 'stats') {
          setSection('stats');
        }
      } catch(e) {
        alert('שגיאה בפענוח JSON. אנא בדוק את הנתונים ונסה שוב.');
      }
    });
  }

  // --- אתחול ראשוני ---

  loadState();
  setSection(currentSection);

</script>
</body>
</html>
